@inject EventAggregator EventAggregator
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILocalStorageService LocalStorage

<MudBadge Content="@_receivedMessages.Count" Overlap="true" Class="mx-6 my-4">
    <MudIcon
        Icon="@(AreNotifications ? Icons.Material.Filled.NotificationsActive : Icons.Material.Filled.Notifications)" Disabled="@(!AreNotifications)"/>
</MudBadge>

@code {

    private CurrentUser _currentUser = new();

    private bool AreNotifications { get; set; }

    private readonly List<string> _receivedMessages = [];

    private ServiceBusClient _client = null!;
    private ServiceBusProcessor _processor = null!;

    private readonly DialogOptions _dialogOptions = new() { CloseButton = true, NoHeader = true, MaxWidth = MaxWidth.Medium, Position = DialogPosition.TopRight, CloseOnEscapeKey = true };

    protected override void OnInitialized()
    {
        base.OnInitialized();
        EventAggregator.Subscribe("logged", StartProcessing);
        EventAggregator.Subscribe("NotifCleared", Clear);
    }

    private async Task ShowDialog()
    {
        var parameters = new DialogParameters<NotificationDialog>
        {
            { x => x.Notifications, _receivedMessages },
        };

        await DialogService.ShowAsync<PostDialog>("", parameters, _dialogOptions);
    }

    private async Task Clear()
    {
        _receivedMessages.Clear();
        AreNotifications = false;
        StateHasChanged();
    }

    private async Task StartProcessing()
    {
        if (!await LocalStorage.ContainKeyAsync("user"))
        {
            return;
        }

        _currentUser = await LocalStorage.GetItemAsync<CurrentUser>("user");

        if (_currentUser == null)
        {
            return;
        }

        var clientOptions = new ServiceBusClientOptions
        {
            TransportType = ServiceBusTransportType.AmqpWebSockets
        };
        _client = new ServiceBusClient(DontCommit.TopicKey, clientOptions);
        _processor = _client.CreateProcessor("testtopic", _currentUser.Email.Replace("@", "__"), new ServiceBusProcessorOptions());
        _processor.ProcessMessageAsync += ProcessMessages;
        _processor.ProcessErrorAsync += ErrorHandler;
        await _processor.StartProcessingAsync();
    }

    private async Task ProcessMessages(ProcessMessageEventArgs args)
    {
        var body = args.Message.Body.ToString();

        if (_currentUser != null && body.Contains(_currentUser.UserName))
        {
            return;
        }

        _receivedMessages.Add(body);
        AreNotifications = true;
        StateHasChanged();

        await args.CompleteMessageAsync(args.Message);
    }

    private Task ErrorHandler(ProcessErrorEventArgs args)
    {
        Console.WriteLine($"Error source: {args.Exception.Source}, Exception: {args.Exception.Message}");

        Snackbar.Add("Some error occured in notification receive task.", Severity.Error);

        return Task.CompletedTask;
    }

}